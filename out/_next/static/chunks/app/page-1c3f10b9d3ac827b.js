(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{6716:function(e,s,t){Promise.resolve().then(t.bind(t,2851))},2851:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return K}});var a=t(7437),l=t(2265),i=t(4280),n=t(6141),r=t(1298),d=t(5790),c=t(1981),o=t(3523),x=t(3008),m=t(2104),u=t(998),h=t(9224);function p(e){var s,t,l,i,x,m,u,h,p,v;let{requestLogs:b,summary:g}=e,j=b.find(e=>"SSP"===e.node&&"REQUEST_GENERATED"===e.action),N=b.find(e=>"BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action),f=b.find(e=>"AUCTION_RESULT"===e.action),_=b.find(e=>"LATENCY_TIMEOUT"===e.reason_code),y=(null==j?void 0:j.latency_ms)||(null===(s=b.find(e=>e.latency_ms))||void 0===s?void 0:s.latency_ms)||(null==_?void 0:_.latency_ms),E=(null==f?void 0:null===(t=f.internal_variables)||void 0===t?void 0:t.winner_bid)||(null==N?void 0:null===(l=N.internal_variables)||void 0===l?void 0:l.final_bid)||(null==N?void 0:null===(i=N.internal_variables)||void 0===i?void 0:i.bid_price)||g.bid_price,w=(null==f?void 0:f.pCTR)||(null==N?void 0:N.pCTR)||(null==N?void 0:null===(x=N.internal_variables)||void 0===x?void 0:x.pctr),C=(null==f?void 0:f.pCVR)||(null==N?void 0:N.pCVR)||(null==N?void 0:null===(m=N.internal_variables)||void 0===m?void 0:m.pcvr),T=(null==f?void 0:f.eCPM)||(null==f?void 0:null===(u=f.internal_variables)||void 0===u?void 0:u.winner_ecpm)||(E&&w&&C?E*w*C*1e3:null),S=null==f?void 0:f.actual_paid_price,I=null==f?void 0:f.saved_amount,A=null==f?void 0:f.second_best_bid,D=(null==f?void 0:f.eCPM)||(null==f?void 0:null===(h=f.internal_variables)||void 0===h?void 0:h.winner_ecpm),L=null==_?void 0:null===(p=_.internal_variables)||void 0===p?void 0:p.max_potential_ecpm,R=(null==_?void 0:null===(v=_.internal_variables)||void 0===v?void 0:v.timeout_threshold)||100;return(0,a.jsxs)("div",{className:"mt-3 space-y-3",children:[null!=y&&(0,a.jsxs)("div",{className:"bg-blue-50 p-2 rounded-lg border border-blue-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)(n.Z,{className:"w-3.5 h-3.5 text-indigo-700"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-indigo-700",children:"处理耗时"})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-700",children:[y.toFixed(1),"ms",_&&(0,a.jsxs)("span",{className:"ml-2 text-red-600 font-semibold",children:["(超过阈值 ",R,"ms)"]})]})]}),E&&E>0&&(0,a.jsxs)("div",{className:"bg-purple-50 p-2 rounded-lg border border-purple-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5",children:[(0,a.jsx)(r.Z,{className:"w-3.5 h-3.5 text-indigo-700"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-indigo-700",children:"出价详细构成"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-1.5 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"出价:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:["\xa5",E.toFixed(2)]})]}),null!=w&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"pCTR:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:[(100*w).toFixed(2),"%"]})]}),null!=C&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"pCVR:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:[(100*C).toFixed(2),"%"]})]}),null!=T&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"eCPM:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:["\xa5",T.toFixed(2)]})]})]})]}),"ACCEPTED"===g.status&&f&&(0,a.jsxs)("div",{className:"bg-green-50 p-2 rounded-lg border border-green-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5",children:[(0,a.jsx)(d.Z,{className:"w-3.5 h-3.5 text-green-600"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-green-700",children:"中标信息"})]}),(0,a.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"胜利原因:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:["eCPM 最高 (\xa5",(null==D?void 0:D.toFixed(2))||"N/A",")"]})]}),null!=S&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"实际成交价:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-indigo-700 font-semibold",children:["\xa5",S.toFixed(2)]}),null!=I&&I>0&&(0,a.jsxs)("span",{className:"ml-2 text-green-600",children:["(节省: ",(0,a.jsxs)("span",{className:"font-bold",children:["\xa5",I.toFixed(2)]}),")"]})]}),null!=A&&(0,a.jsxs)("div",{className:"text-[10px] text-gray-500 mt-0.5",children:["第二高出价: \xa5",A.toFixed(2)]})]})]}),"REJECTED"===g.status&&"LATENCY_TIMEOUT"===g.reason_code&&_&&(0,a.jsxs)("div",{className:"bg-red-50 p-2 rounded-lg border border-red-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3.5 h-3.5 text-red-600"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-red-700",children:"响应超时损失"})]}),(0,a.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"耗时:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-red-700 font-semibold",children:[(null==y?void 0:y.toFixed(1))||"N/A","ms"]}),(0,a.jsxs)("span",{className:"ml-1.5 text-red-600 text-[10px]",children:["(超过阈值 ",R,"ms)"]})]}),null!=L&&L>0&&(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"错失潜在最高 eCPM:"}),(0,a.jsxs)("span",{className:"ml-1.5 text-red-700 font-bold",children:["\xa5",L.toFixed(2)]})]})]})]}),(0,a.jsxs)("details",{className:"mt-3",children:[(0,a.jsxs)("summary",{className:"text-xs text-light-text-muted cursor-pointer hover:text-light-text flex items-center gap-1 mb-2",children:["查看完整日志详情",(0,a.jsx)(o.Z,{className:"w-3 h-3"})]}),(0,a.jsx)("div",{className:"space-y-2",children:b.map((e,s)=>(0,a.jsxs)("div",{className:"bg-gray-50 p-2 rounded border border-gray-100",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5",children:[(0,a.jsx)("span",{className:"text-[10px] font-semibold text-indigo-700",children:e.node}),(0,a.jsx)("span",{className:"text-[10px] text-gray-500",children:e.action}),(0,a.jsx)("span",{className:"text-[10px] px-1 py-0.5 rounded ".concat("PASS"===e.decision?"bg-green-100 text-green-700":"bg-red-100 text-red-700"),children:e.decision})]}),(0,a.jsx)("pre",{className:"text-[10px] text-gray-600 overflow-x-auto",children:JSON.stringify(e,null,2)})]},s))})]})]})}function v(e){let{logs:s,onRequestClick:t}=e,[i,r]=(0,l.useState)(new Set),[d,c]=(0,l.useState)([]);(0,l.useEffect)(()=>{let e=new Map;s.forEach(s=>{e.has(s.request_id)||e.set(s.request_id,[]),e.get(s.request_id).push(s)});let t=Array.from(e.entries()).map(e=>{var s,t,a,l,i,n,r,d,c,o;let[x,m]=e,u=m.find(e=>"AUCTION_RESULT"===e.action),h=u||m.find(e=>"FINAL_DECISION"===e.action||"BID_SUBMITTED"===e.action||"ADX"===e.node&&e.action.includes("CHECK")&&"REJECT"===e.decision),p=m.find(e=>"BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action),v="PENDING";u?v="ACCEPTED":h&&(v="REJECT"===h.decision?"REJECTED":"PASS"===h.decision?"ACCEPTED":"PENDING");let b=(null==u?void 0:u.pCTR)||(null==p?void 0:p.pCTR)||(null==p?void 0:null===(s=p.internal_variables)||void 0===s?void 0:s.pctr),g=(null==u?void 0:u.pCVR)||(null==p?void 0:p.pCVR)||(null==p?void 0:null===(t=p.internal_variables)||void 0===t?void 0:t.pcvr),j=(null==u?void 0:null===(a=u.internal_variables)||void 0===a?void 0:a.winner_bid)||(null==p?void 0:null===(l=p.internal_variables)||void 0===l?void 0:l.final_bid)||(null==p?void 0:null===(i=p.internal_variables)||void 0===i?void 0:i.bid_price),N=(null==u?void 0:u.eCPM)||(null==u?void 0:null===(n=u.internal_variables)||void 0===n?void 0:n.winner_ecpm)||(j&&b&&g?j*b*g*1e3:null),f=null==u?void 0:u.saved_amount;return{request_id:x,timestamp:(null===(r=m[0])||void 0===r?void 0:r.timestamp)||"",status:v,reason_code:null==h?void 0:h.reason_code,bid_price:j,node:(null==h?void 0:h.node)||(null===(d=m[0])||void 0===d?void 0:d.node)||"UNKNOWN",action:(null==h?void 0:h.action)||(null===(c=m[0])||void 0===c?void 0:c.action)||"UNKNOWN",reasoning:(null==h?void 0:h.reasoning)||(null===(o=m[0])||void 0===o?void 0:o.reasoning)||"",pctr:b||null,pcvr:g||null,ecpm:N||null,saved_amount:f||null}});t.sort((e,s)=>new Date(s.timestamp).getTime()-new Date(e.timestamp).getTime()),c(t.slice(0,50))},[s]);let v=e=>{let s=new Set(i);s.has(e)?s.delete(e):s.add(e),r(s)},b=e=>{switch(e){case"ACCEPTED":return(0,a.jsx)(x.Z,{className:"w-4 h-4 text-green-600"});case"REJECTED":return(0,a.jsx)(m.Z,{className:"w-4 h-4 text-red-600"});default:return(0,a.jsx)(n.Z,{className:"w-4 h-4 text-amber-600"})}},[g,j]=(0,l.useState)(!1);(0,l.useEffect)(()=>{j(!0)},[]);let N=e=>{if(!g)return"--:--:--";try{return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3})}catch(s){return e}};return(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 p-2.5 border-b border-gray-100",children:[(0,a.jsx)(u.Z,{className:"w-3.5 h-3.5 text-indigo-700"}),(0,a.jsx)("h2",{className:"text-sm font-semibold text-[#1e293b]",children:"实时交易流"}),(0,a.jsxs)("span",{className:"ml-auto text-[10px] text-gray-500",children:[d.length," 条"]})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===d.length?(0,a.jsx)("div",{className:"p-6 text-center text-gray-500 text-xs",children:"暂无交易记录"}):(0,a.jsx)("div",{className:"divide-y divide-gray-100",children:d.map(e=>{let l=i.has(e.request_id),n=s.filter(s=>s.request_id===e.request_id);return(0,a.jsxs)("div",{className:"bg-white hover:bg-gray-50/50 transition-colors border-b border-gray-50",children:[(0,a.jsx)("div",{className:"p-2 cursor-pointer ".concat("REJECTED"===e.status?"hover:bg-red-50/30":""),onClick:()=>{"REJECTED"===e.status&&t?t(e.request_id):v(e.request_id)},children:(0,a.jsxs)("div",{className:"flex items-start gap-1.5",children:[b(e.status),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-0.5 flex-wrap",children:[(0,a.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded font-semibold ".concat("ACCEPTED"===e.status?"bg-green-100 text-green-700":"REJECTED"===e.status?"bg-red-100 text-red-700":"bg-amber-100 text-amber-700"),children:"ACCEPTED"===e.status?"竞价成功":"REJECTED"===e.status?({LATENCY_TIMEOUT:"响应超时",SIZE_MISMATCH:"尺寸不匹配",IN_BLACKLIST:"黑名单过滤",CREATIVE_MISMATCH:"素材不合规",FLOOR_PRICE_HIGH:"底价过高",BID_BELOW_FLOOR:"出价低于底价",REJECTED:"已拒绝"})[e.reason_code||""]||"已拒绝":"处理中"}),(0,a.jsxs)("span",{className:"text-[9px] font-mono text-gray-500",children:["Req-",e.request_id.slice(-4)]})]}),(0,a.jsx)("div",{className:"text-[9px] text-gray-500 mb-0.5",children:N(e.timestamp)}),(0,a.jsx)("div",{className:"text-[10px] text-gray-600 line-clamp-1 mb-1",children:e.reasoning||e.action}),(0,a.jsxs)("div",{className:"flex items-center gap-1 flex-wrap",children:[null!==e.pctr&&void 0!==e.pctr&&(0,a.jsxs)("span",{className:"text-[9px] px-1 py-0.5 bg-purple-50 text-purple-700 rounded border border-purple-100 font-medium",children:["pCTR: ",(100*e.pctr).toFixed(1),"%"]}),(()=>{var t;let l=s.filter(s=>s.request_id===e.request_id).find(e=>"BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action),i=(null==l?void 0:l.pCVR)||(null==l?void 0:null===(t=l.internal_variables)||void 0===t?void 0:t.pcvr);return i?(0,a.jsxs)("span",{className:"text-[9px] px-1 py-0.5 bg-indigo-50 text-indigo-700 rounded border border-indigo-100 font-medium",children:["pCVR: ",(100*i).toFixed(1),"%"]}):null})(),null!==e.ecpm&&void 0!==e.ecpm&&(0,a.jsxs)("span",{className:"text-[9px] px-1 py-0.5 bg-blue-50 text-blue-700 rounded border border-blue-100 font-medium",children:["eCPM: \xa5",e.ecpm.toFixed(2)]}),null!==e.saved_amount&&void 0!==e.saved_amount&&e.saved_amount>0&&(0,a.jsxs)("span",{className:"text-[8px] text-green-600 font-medium",children:["已省 \xa5",e.saved_amount.toFixed(2)]}),e.bid_price&&!e.ecpm&&(0,a.jsxs)("span",{className:"text-[9px] px-1 py-0.5 bg-gray-50 text-gray-600 rounded border border-gray-100",children:["出价: \xa5",e.bid_price.toFixed(2)]})]})]}),l?(0,a.jsx)(h.Z,{className:"w-3 h-3 text-gray-500 flex-shrink-0"}):(0,a.jsx)(o.Z,{className:"w-3 h-3 text-gray-500 flex-shrink-0"})]})}),l&&(0,a.jsx)("div",{className:"px-2 pb-2 border-t border-gray-100",children:(0,a.jsx)(p,{requestLogs:n,summary:e})})]},e.request_id)})})})]})}var b=t(4522);function g(e){let{data:s}=e,{request:t,valid:l,bid:i,win:n}=s,r=[{name:"Request",value:t,color:"bg-blue-500",label:"请求数"},{name:"Valid",value:l,color:"bg-purple-500",label:"有效请求"},{name:"Bid",value:i,color:"bg-yellow-500",label:"出价数"},{name:"Win",value:n,color:"bg-green-500",label:"中标数"}],c=(e,s)=>0===s?0:Math.max(e/s*100,5),o=(e,s)=>0===s?0:(e/s*100).toFixed(1),x=Math.max(t,1);return(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-100 p-3 shadow-subtle",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsx)("h2",{className:"text-sm font-semibold text-[#1e293b]",children:"损耗漏斗"}),(0,a.jsx)("div",{className:"text-xs text-gray-500",children:"实时更新"})]}),(0,a.jsx)("div",{className:"space-y-4",children:r.map((e,s)=>{let l=s>0?r[s-1].value:t,i=o(e.value,l),n=c(e.value,x),m=s>0&&e.value<l;return(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded ".concat(e.color)}),(0,a.jsx)("span",{className:"text-xs font-medium text-gray-700",children:e.label})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("span",{className:"text-base font-bold text-blue-600",children:e.value}),s>0&&(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs",children:[m?(0,a.jsx)(b.Z,{className:"w-3 h-3 text-red-600"}):(0,a.jsx)(d.Z,{className:"w-3 h-3 text-green-600"}),(0,a.jsxs)("span",{className:m?"text-red-600":"text-green-600",children:[i,"%"]})]})]})]}),(0,a.jsxs)("div",{className:"relative h-7 bg-gray-50 rounded overflow-hidden border border-gray-100",children:[(0,a.jsx)("div",{className:"h-full ".concat(e.color," transition-all duration-500 ease-out flex items-center justify-end pr-2"),style:{width:"".concat(n,"%")},children:e.value>0&&n>15&&(0,a.jsx)("span",{className:"text-xs font-semibold text-white",children:e.value})}),e.value>0&&n<=15&&(0,a.jsx)("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-xs font-semibold text-gray-700",children:e.value})]})]},e.name)})}),(0,a.jsx)("div",{className:"mt-3 pt-2 border-t border-gray-100",children:(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-xs",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"总请求数: "}),(0,a.jsx)("span",{className:"text-blue-600 font-semibold",children:t})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-500",children:"中标率: "}),(0,a.jsxs)("span",{className:"text-blue-600 font-semibold",children:[t>0?(n/t*100).toFixed(2):0,"%"]})]})]})})]})}var j=t(4056),N=t(7158);function f(e){let{timestamp:s}=e,[t,i]=(0,l.useState)(!1),[n,r]=(0,l.useState)("");return((0,l.useEffect)(()=>{i(!0)},[]),(0,l.useEffect)(()=>{if(t)try{r(new Date(s).toLocaleString("zh-CN"))}catch(e){r(s)}},[t,s]),t)?(0,a.jsx)("div",{className:"mt-1 text-[10px] text-gray-500",children:n}):(0,a.jsx)("div",{className:"mt-1 text-[10px] text-gray-500",children:"--:--:--"})}let _=(e,s)=>{let t={BID_BELOW_FLOOR:e=>{let s=e.bid_price||0,t=e.floor_price||0;return"出价 \xa5".concat(s.toFixed(4)," 低于底价 \xa5").concat(t.toFixed(4),"，相差 \xa5").concat((t-s).toFixed(4))},BID_ABOVE_FLOOR:e=>{var s,t;return"出价 \xa5".concat((null===(s=e.bid_price)||void 0===s?void 0:s.toFixed(4))||0," 高于底价 \xa5").concat((null===(t=e.floor_price)||void 0===t?void 0:t.toFixed(4))||0,"，通过底价检查")},IN_BLACKLIST:e=>{let s=e.device_id||"",t=e.app_id||"";return"设备 ".concat(s," 或应用 ").concat(t," 在黑名单中，请求被拒绝")},NOT_IN_BLACKLIST:e=>"设备 ".concat(e.device_id||""," 和应用 ").concat(e.app_id||""," 不在黑名单中，通过检查"),SIZE_MISMATCH:e=>{let s=e.ad_size||[],t=e.required_size||[];return"广告尺寸 ".concat(s.join("\xd7")," 尺寸不匹配要求尺寸 ").concat(t.join("\xd7"))},SIZE_MATCHED:e=>{var s,t;return"广告尺寸 ".concat((null===(s=e.ad_size)||void 0===s?void 0:s.join("\xd7"))||""," 匹配要求尺寸 ").concat((null===(t=e.required_size)||void 0===t?void 0:t.join("\xd7"))||"")},ALL_FILTERS_PASSED:e=>"所有 ".concat(e.filters_count||0," 个过滤规则均通过，请求被接受"),CTR_CALCULATED:e=>{var s;return"CTR 得分估算为 ".concat((null===(s=e.ctr_score)||void 0===s?void 0:s.toFixed(2))||0,"（平台：").concat(e.platform||"UNKNOWN","，时段：").concat(e.hour||0,"点）")},BID_CALCULATED:e=>{let s=e.base_price||0,t=e.ctr_score||0,a=e.multiplier||1,l=e.final_bid||0;return"出价计算：基础价 \xa5".concat(s.toFixed(2)," \xd7 CTR ").concat(t.toFixed(2)," \xd7 乘数 ").concat(a.toFixed(2)," = \xa5").concat(l.toFixed(4))},BID_SUBMITTED:e=>{var s,t;return"DSP 提交出价：\xa5".concat((null===(s=e.final_bid)||void 0===s?void 0:s.toFixed(4))||(null===(t=e.bid_price)||void 0===t?void 0:t.toFixed(4))||0)},REQUEST_CREATED:e=>{var s;let t=e.pctr?"，预估点击率 ".concat((100*e.pctr).toFixed(2),"%"):"";return"SSP 生成广告请求：设备 ".concat(e.device_id||"","，应用 ").concat(e.app_name||""," (").concat(e.app_id||"",")，平台 ").concat(e.platform||"","，尺寸 ").concat((null===(s=e.ad_size)||void 0===s?void 0:s.join("\xd7"))||"").concat(t)},LATENCY_TIMEOUT:e=>"响应延迟 ".concat(e.latency_ms||0,"ms 超过阈值 ").concat(e.max_latency_ms||100,"ms，响应超时"),LATENCY_OK:e=>"响应延迟 ".concat(e.latency_ms||0,"ms 在允许范围内（≤").concat(e.max_latency_ms||100,"ms）"),CREATIVE_MISMATCH:e=>"素材不合规，被拒绝（可能包含违规内容、尺寸不符等）",CREATIVE_COMPLIANT:e=>"素材通过合规性检查",FLOOR_PRICE_HIGH:e=>{var s,t,a;return"出价 \xa5".concat((null===(s=e.bid_price)||void 0===s?void 0:s.toFixed(4))||0," 低于底价 \xa5").concat((null===(t=e.floor_price)||void 0===t?void 0:t.toFixed(4))||0,"，底价设置可能过高，导致 \xa5").concat((null===(a=e.price_gap)||void 0===a?void 0:a.toFixed(4))||0," 的潜在收入损失")},AUCTION_WON:e=>{var s,t,a;return"竞价完成：出价 \xa5".concat((null===(s=e.winner_bid)||void 0===s?void 0:s.toFixed(4))||0,"，实际支付 \xa5").concat((null===(t=e.actual_payment)||void 0===t?void 0:t.toFixed(4))||0,"（二价计费），节省 \xa5").concat((null===(a=e.bid_shading)||void 0===a?void 0:a.toFixed(4))||0)}}[e];return t?t(s):"原因代码：".concat(e)};function y(e){let{logs:s,selectedRequestId:t,onRequestSelect:i}=e,[n,r]=(0,l.useState)([]);if((0,l.useEffect)(()=>{t?r(s.filter(e=>e.request_id===t).sort((e,s)=>new Date(e.timestamp).getTime()-new Date(s.timestamp).getTime())):r([])},[t,s]),!t)return(0,a.jsx)("div",{className:"h-full flex items-center justify-center bg-white rounded-lg border border-gray-100 shadow-subtle",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(j.Z,{className:"w-10 h-10 text-gray-500 mx-auto mb-3"}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:"点击左侧失败请求查看白盒排查详情"})]})});let d=n.find(e=>"FINAL_DECISION"===e.action||"ADX"===e.node&&"REJECT"===e.decision),o=(null==d?void 0:d.decision)==="REJECT",u=null==d?void 0:d.reason_code;return(0,a.jsxs)("div",{className:"h-full flex flex-col bg-white rounded-lg border border-gray-100 shadow-subtle",children:[(0,a.jsx)("div",{className:"p-2.5 border-b border-gray-100",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[o?(0,a.jsx)(m.Z,{className:"w-4 h-4 text-red-600"}):(0,a.jsx)(x.Z,{className:"w-4 h-4 text-green-600"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-sm font-semibold text-[#1e293b]",children:"白盒排查"}),(0,a.jsx)("p",{className:"text-[10px] text-gray-500",children:t.slice(-12)})]})]}),(0,a.jsx)("button",{onClick:()=>i(null),className:"text-xs text-gray-500 hover:text-gray-700 transition-colors",children:"关闭"})]})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-2.5",children:[o&&u&&(0,a.jsx)("div",{className:"mb-3 p-2.5 bg-red-50 border border-red-200 rounded-lg",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(c.Z,{className:"w-4 h-4 text-red-600 flex-shrink-0 mt-0.5"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("h3",{className:"text-xs font-semibold text-red-700 mb-1",children:"拒绝原因"}),(0,a.jsx)("p",{className:"text-xs text-gray-700",children:_(u,(null==d?void 0:d.internal_variables)||{})}),(0,a.jsxs)("p",{className:"text-[10px] text-gray-500 mt-1.5",children:["Reason Code: ",(0,a.jsx)("code",{className:"bg-gray-100 px-1 py-0.5 rounded",children:u})]})]})]})}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-xs font-semibold text-gray-700 mb-2",children:"决策链路追踪"}),n.map((e,s)=>{let t="REJECT"===e.decision,l=o&&e.reason_code===u;return(0,a.jsx)("div",{className:"p-2.5 rounded-lg border transition-all ".concat(l?"bg-red-50 border-red-300":t?"bg-red-50/50 border-red-200":"bg-white border-gray-100"),children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)("div",{className:"flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold ".concat(t?"bg-red-100 text-red-700":"bg-green-100 text-green-700"),children:s+1}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5 flex-wrap",children:[(0,a.jsx)("span",{className:"text-[10px] font-semibold px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-700",children:e.node}),(0,a.jsx)("span",{className:"text-[10px] text-gray-500",children:e.action}),(0,a.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded ".concat("PASS"===e.decision?"bg-green-100 text-green-700":"bg-red-100 text-red-700"),children:e.decision}),e.reason_code&&(0,a.jsx)("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-100 text-gray-600",children:_(e.reason_code,e.internal_variables)})]}),(0,a.jsx)("div",{className:"mb-1.5",children:(0,a.jsx)("p",{className:"text-xs text-gray-700",children:_(e.reason_code,e.internal_variables)})}),e.reasoning&&(0,a.jsx)("div",{className:"mt-1.5 pt-1.5 border-t border-gray-100",children:(0,a.jsx)("p",{className:"text-[10px] text-gray-500",children:e.reasoning})}),Object.keys(e.internal_variables).length>0&&(0,a.jsxs)("details",{className:"mt-1.5",children:[(0,a.jsxs)("summary",{className:"text-[10px] text-gray-500 cursor-pointer hover:text-gray-700 flex items-center gap-1",children:["查看内部变量",(0,a.jsx)(N.Z,{className:"w-2.5 h-2.5"})]}),(0,a.jsx)("pre",{className:"mt-1.5 text-[10px] text-gray-600 bg-gray-50 p-2 rounded overflow-x-auto border border-gray-100",children:JSON.stringify(e.internal_variables,null,2)})]}),(0,a.jsx)(f,{timestamp:e.timestamp})]})]})},s)})]})]})]})}var E=t(5253),w=t(1125),C=t(6573),T=t(4235),S=t(39),I=t(6812),A=t(7978),D=t(9857),L=t(7586);function R(e){let{logs:s}=e,t=(0,l.useMemo)(()=>{let e=[],t=new Map;return s.forEach(e=>{t.has(e.request_id)||t.set(e.request_id,[]),t.get(e.request_id).push(e)}),t.forEach((s,t)=>{var a,l,i,n;let r=s.find(e=>"AUCTION_RESULT"===e.action),d=s.find(e=>"LATENCY_TIMEOUT"===e.reason_code),c=s.find(e=>"FINAL_DECISION"===e.action||"ADX"===e.node&&"REJECT"===e.decision),o=(null==d?void 0:d.latency_ms)||(null===(a=s.find(e=>e.latency_ms))||void 0===a?void 0:a.latency_ms)||(null===(i=s.find(e=>{var s;return"SSP"===e.node&&(null===(s=e.internal_variables)||void 0===s?void 0:s.latency_ms)}))||void 0===i?void 0:null===(l=i.internal_variables)||void 0===l?void 0:l.latency_ms),x=(null==r?void 0:r.eCPM)||(null==r?void 0:null===(n=r.internal_variables)||void 0===n?void 0:n.winner_ecpm)||(()=>{if(d){var e,t;let s=(null===(e=d.internal_variables)||void 0===e?void 0:e.highest_potential_ecpm_loss)||(null===(t=d.internal_variables)||void 0===t?void 0:t.max_potential_ecpm);if(s)return s}let a=s.filter(e=>"BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action),l=0;return a.forEach(e=>{var s,t,a,i;let n=(null===(s=e.internal_variables)||void 0===s?void 0:s.final_bid)||(null===(t=e.internal_variables)||void 0===t?void 0:t.bid_price),r=e.pCTR||(null===(a=e.internal_variables)||void 0===a?void 0:a.pctr),d=e.pCVR||(null===(i=e.internal_variables)||void 0===i?void 0:i.pcvr);n&&r&&d&&(l=Math.max(l,n*r*d*1e3))}),l>0?l:null})();if(null!=o&&null!=x&&x>0){let s="loss";d?s="timeout":(r||c&&"PASS"===c.decision)&&(s="win"),e.push({latency:Number(o),ecpm:Number(x),status:s,request_id:t})}}),e},[s]),i=t.filter(e=>"win"===e.status),n=t.filter(e=>"timeout"===e.status),r=t.filter(e=>"loss"===e.status);return(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-100 p-3 shadow-subtle",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-sm font-semibold text-[#1e293b]",children:"系统延迟与胜率分布"}),(0,a.jsx)("p",{className:"text-[10px] text-gray-500 mt-0.5",children:"展示延迟对竞价结果的影响"})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:[t.length," 个数据点"]})]}),(0,a.jsx)(E.h,{width:"100%",height:300,children:(0,a.jsxs)(w.G,{margin:{top:15,right:15,bottom:15,left:15},children:[(0,a.jsx)(C.q,{strokeDasharray:"3 3",stroke:"#f3f4f6"}),(0,a.jsx)(T.K,{type:"number",dataKey:"latency",name:"延迟",unit:"ms",label:{value:"延迟 (ms)",position:"insideBottom",offset:-5},domain:[0,"dataMax + 20"]}),(0,a.jsx)(S.B,{type:"number",dataKey:"ecpm",name:"eCPM",unit:"\xa5",label:{value:"eCPM 出价 (\xa5)",angle:-90,position:"insideLeft"},domain:[0,"dataMax * 1.1"]}),(0,a.jsx)(I.u,{content:(0,a.jsx)(e=>{let{active:s,payload:t}=e;if(s&&t&&t.length){let e=t[0].payload;return(0,a.jsxs)("div",{className:"bg-white p-3 border border-light-border rounded-lg shadow-lg",children:[(0,a.jsxs)("p",{className:"text-sm font-semibold text-light-text mb-1",children:["Request: ",e.request_id.slice(-8)]}),(0,a.jsxs)("p",{className:"text-xs text-light-text-muted",children:["延迟: ",(0,a.jsxs)("span",{className:"font-semibold",children:[e.latency.toFixed(1),"ms"]})]}),(0,a.jsxs)("p",{className:"text-xs text-light-text-muted",children:["eCPM: ",(0,a.jsxs)("span",{className:"font-semibold",children:["\xa5",e.ecpm.toFixed(4)]})]}),(0,a.jsxs)("p",{className:"text-xs text-light-text-muted",children:["状态: ",(0,a.jsx)("span",{className:"font-semibold ".concat("win"===e.status?"text-green-600":"timeout"===e.status?"text-red-600":"text-gray-600"),children:"win"===e.status?"中标":"timeout"===e.status?"超时":"落败"})]})]})}return null},{})}),(0,a.jsx)(A.d,{x:100,stroke:"#ef4444",strokeWidth:2,strokeDasharray:"5 5",label:{value:"100ms 阈值",position:"top",fill:"#ef4444"}}),(0,a.jsx)(D.D,{wrapperStyle:{paddingTop:"20px"},iconType:"circle"}),(0,a.jsx)(L.b,{name:"中标",data:i,fill:"#059669",stroke:"#047857",strokeWidth:1.5}),(0,a.jsx)(L.b,{name:"超时被拒",data:n,fill:"#dc2626",stroke:"#b91c1c",strokeWidth:1.5}),(0,a.jsx)(L.b,{name:"其他原因落败",data:r,fill:"#6b7280",stroke:"#4b5563",strokeWidth:1})]})}),(0,a.jsx)("div",{className:"mt-2 pt-2 border-t border-gray-100",children:(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-2 text-xs",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-base font-bold text-green-600",children:i.length}),(0,a.jsx)("div",{className:"text-[10px] text-gray-500",children:"中标"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-base font-bold text-red-600",children:n.length}),(0,a.jsx)("div",{className:"text-[10px] text-gray-500",children:"超时被拒"})]}),(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-base font-bold text-gray-600",children:r.length}),(0,a.jsx)("div",{className:"text-[10px] text-gray-500",children:"其他原因落败"})]})]})})]})}var M=t(272);function O(){var e,s;let[t,i]=(0,l.useState)(null),[n,r]=(0,l.useState)(!1),d=async()=>{r(!0);try{let e={status:"success",timestamp:new Date().toISOString(),ai_suggestions:{summary:"ADX 上流流量上涨 23.5%，平均出价下降 2.1%，整体胜率下滑 1.8%",root_cause:"已识别到 3 个次要流量波动：已识别到 3 个次要流量波动：已识别到 3 个次要流量波动",economic_impact:"月度潜在损失 $12,500，其中延迟超时占 68%，素材不合规占 18%",suggestions:["优先上线延迟优化策略，预计可挂回 $8,500","对已拒绝的素材进行 A/B 测试，优化活动性","在已识别的高价值时段流量上流 15% 出价"],priority:"HIGH"},estimated_hourly_loss:520.5};i(e)}catch(e){console.error("Error fetching diagnostic:",e)}finally{r(!1)}};(0,l.useEffect)(()=>{d();let e=setInterval(d,3e4);return()=>clearInterval(e)},[]);let c=null==t?void 0:t.ai_suggestions,o=e=>{let s=[],t=e.match(/[\$¥]\d+[.,]?\d*/g);t&&s.push(...t);let a=e.match(/\d+[.,]?\d*%/g);return a&&s.push(...a),s},x=e=>{if(!e)return"";let s=o(e),t=e,a=new Set;return s.forEach(e=>{if(!a.has(e)){a.add(e);let s=RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g");t=t.replace(s,'<span class="font-bold text-blue-700 bg-blue-100 px-1 rounded">'.concat(e,"</span>"))}}),t};return c||(null==t?void 0:t.total_potential_loss)?(0,a.jsxs)("div",{className:"bg-white rounded border border-gray-100 p-2.5",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-2",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(M.Z,{className:"w-3.5 h-3.5 text-blue-600"}),(0,a.jsx)("div",{className:"absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-20"})]}),(0,a.jsx)("h3",{className:"text-xs font-bold text-[#1e293b]",children:"智能诊断与决策建议"}),(0,a.jsx)("span",{className:"text-[9px] text-gray-500",children:"AI Insights"}),(null==t?void 0:t.estimated_hourly_loss)&&(0,a.jsxs)("span",{className:"ml-auto text-[10px] text-gray-500",children:["预计损失: ",(0,a.jsxs)("span",{className:"font-bold text-red-600",children:["\xa5",t.estimated_hourly_loss.toFixed(2),"/h"]})]})]}),(0,a.jsxs)("div",{className:"space-y-1.5 text-[10px]",children:[(null==t?void 0:null===(s=t.ai_suggestions)||void 0===s?void 0:null===(e=s.suggestions)||void 0===e?void 0:e.some(e=>e.includes("隐私受限环境")||e.includes("SKAN")))&&(0,a.jsxs)("div",{className:"mb-2 p-1.5 bg-blue-50 border border-blue-200 rounded",children:[(0,a.jsx)("div",{className:"flex items-center gap-1 mb-0.5",children:(0,a.jsx)("span",{className:"text-[9px] font-bold text-blue-700",children:"\uD83D\uDD12 隐私环境诊断"})}),t.ai_suggestions.suggestions.filter(e=>e.includes("隐私受限环境")||e.includes("SKAN")).map((e,s)=>(0,a.jsx)("div",{className:"text-[9px] text-blue-700 leading-relaxed",children:e.replace(/【策略预警】/g,"").replace(/【P8 策略建议】/g,"")},s))]}),(null==c?void 0:c.summary)&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[9px] font-semibold text-[#1e293b] mb-0.5",children:"【现象总结】"}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed",dangerouslySetInnerHTML:{__html:x(c.summary)}})]}),(null==c?void 0:c.root_cause)&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[9px] font-semibold text-[#1e293b] mb-0.5",children:"【根因推测】"}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed",children:c.root_cause.replace(/【P7 损耗预警】/g,"[策略预警]").replace(/【P8 策略建议】/g,"[策略预警]").replace(/【P7 级决策建议】/g,"").replace(/【P8 级决策建议】/g,"").replace(/pCTR 模型预估偏低/g,"pCTR 预估存在向下偏差").replace(/建议引导广告主优化素材关键词或进行 A\/B Test 以提升质量分/g,"建议立即触发素材 A/B 测试以修正模型质量分")})]}),(null==c?void 0:c.economic_impact)&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[9px] font-semibold text-[#1e293b] mb-0.5",children:"【经济损失评估】"}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed",dangerouslySetInnerHTML:{__html:x(c.economic_impact.replace(/\$/g,"\xa5"))}})]}),(null==c?void 0:c.suggestions)&&c.suggestions.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[9px] font-semibold text-[#1e293b] mb-0.5",children:"【建议操作】"}),(0,a.jsx)("div",{className:"space-y-0.5",children:c.suggestions.slice(0,3).map((e,s)=>(0,a.jsxs)("div",{className:"text-[10px] text-gray-700 flex items-start gap-1.5",children:[(0,a.jsxs)("span",{className:"text-blue-600 font-bold",children:[s+1,"."]}),(0,a.jsx)("span",{children:e.replace(/【P7 损耗预警】/g,"[策略预警]").replace(/【P8 策略建议】/g,"[策略预警]").replace(/【P7 级决策建议】/g,"").replace(/【P8 级决策建议】/g,"").replace(/pCTR 模型预估偏低/g,"pCTR 预估存在向下偏差").replace(/建议引导广告主优化素材关键词或进行 A\/B Test 以提升质量分/g,"建议立即触发素材 A/B 测试以修正模型质量分")})]},s))})]})]})]}):(0,a.jsx)("div",{className:"bg-white rounded border border-gray-100 p-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(M.Z,{className:"w-3.5 h-3.5 text-blue-600 animate-pulse"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-[#1e293b]",children:"智能诊断与决策建议"}),n&&(0,a.jsx)("span",{className:"text-[10px] text-gray-500 ml-auto",children:"分析中..."})]})})}var F=t(6142);function P(e){let{logs:s}=e,t=(0,l.useMemo)(()=>{let e=new Map;s.forEach(s=>{e.has(s.request_id)||e.set(s.request_id,[]),e.get(s.request_id).push(s)});let t=new Map;e.forEach((e,s)=>{var a,l,i,n,r,d,c;let o=e.find(e=>"SSP"===e.node);if(!o)return;let x=(null===(a=o.internal_variables)||void 0===a?void 0:a.app_id)||"",m=(null===(l=o.internal_variables)||void 0===l?void 0:l.app_name)||"",u="Unknown";if(x.toLowerCase().includes("brazil")||m.toLowerCase().includes("brazil"))u="Brazil";else if(x.toLowerCase().includes("china")||m.toLowerCase().includes("china"))u="China";else if(x.toLowerCase().includes("us")||x.toLowerCase().includes("usa"))u="US";else if(x.toLowerCase().includes("sea")||m.toLowerCase().includes("东南亚"))u="Southeast Asia";else if(x.toLowerCase().includes("eu")||m.toLowerCase().includes("europe"))u="Europe";else{let e=x.toLowerCase();u=e.includes("jp")||e.includes("japan")?"Japan":e.includes("kr")||e.includes("korea")?"Korea":e.includes("in")||e.includes("india")?"India":e.includes("au")||e.includes("australia")?"Australia":e.includes("mx")||e.includes("mexico")?"Mexico":e.includes("ca")||e.includes("canada")?"Canada":"Other"}t.has(u)||t.set(u,{region:u,totalRequests:0,totalEcpm:0,winCount:0,avgEcpm:0});let h=t.get(u);h.totalRequests+=1;let p=e.find(e=>"AUCTION_RESULT"===e.action);if(p){h.winCount+=1;let e=p.eCPM||(null===(i=p.internal_variables)||void 0===i?void 0:i.winner_ecpm)||0;h.totalEcpm+=e}else{let s=e.find(e=>"BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action);if(s){let e=(null===(n=s.internal_variables)||void 0===n?void 0:n.final_bid)||(null===(r=s.internal_variables)||void 0===r?void 0:r.bid_price)||0,t=s.pCTR||(null===(d=s.internal_variables)||void 0===d?void 0:d.pctr)||0,a=s.pCVR||(null===(c=s.internal_variables)||void 0===c?void 0:c.pcvr)||0;e&&t&&a&&(h.totalEcpm+=e*t*a*1e3)}}});let a=Array.from(t.values()).map(e=>({...e,avgEcpm:e.totalRequests>0?e.totalEcpm/e.totalRequests:0}));return a.sort((e,s)=>s.totalEcpm-e.totalEcpm),a},[s]),i=Math.max(...t.map(e=>e.totalEcpm),1),n=e=>Math.min(100,Math.max(20,e/i*100));return(0,a.jsxs)("div",{className:"bg-white rounded border border-gray-100 p-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5",children:[(0,a.jsx)(F.Z,{className:"w-3.5 h-3.5 text-blue-600"}),(0,a.jsx)("h2",{className:"text-xs font-semibold text-[#1e293b]",children:"全球流量价值分布"}),(0,a.jsx)("span",{className:"text-[9px] text-gray-500",children:"Revenue Heatmap"})]}),(0,a.jsx)("div",{className:"space-y-1 mb-1.5",children:t.slice(0,5).map(e=>{let s=n(e.totalEcpm);return(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-0.5",children:[(0,a.jsx)("span",{className:"text-[10px] font-semibold text-[#1e293b] truncate",children:e.region}),(0,a.jsxs)("span",{className:"text-[10px] font-bold text-blue-600",children:["$",e.avgEcpm.toFixed(2)]})]}),(0,a.jsx)("div",{className:"h-1.5 bg-gray-100 rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"h-full bg-blue-600 rounded-full transition-all",style:{width:"".concat(s,"%")}})}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-0.5",children:[(0,a.jsxs)("span",{className:"text-[9px] text-gray-500",children:[e.totalRequests," req"]}),(0,a.jsxs)("span",{className:"text-[9px] text-gray-500",children:["Win: ",e.winCount]})]})]})},e.region)})}),t.length>0&&(()=>{let e=t[0],l=new Set;s.forEach(t=>{var a,i;let n=s.find(e=>e.request_id===t.request_id&&"SSP"===e.node);if(!n)return;let r=(null===(a=n.internal_variables)||void 0===a?void 0:a.app_id)||"",d=(null===(i=n.internal_variables)||void 0===i?void 0:i.app_name)||"",c="Unknown";r.toLowerCase().includes("brazil")||d.toLowerCase().includes("brazil")?c="Brazil":r.toLowerCase().includes("china")||d.toLowerCase().includes("china")?c="China":r.toLowerCase().includes("us")||r.toLowerCase().includes("usa")?c="US":r.toLowerCase().includes("sea")||d.toLowerCase().includes("东南亚")?c="Southeast Asia":(r.toLowerCase().includes("eu")||d.toLowerCase().includes("europe"))&&(c="Europe"),c===e.region&&l.add(t.request_id)});let i=s.filter(e=>l.has(e.request_id)).some(e=>"LATENCY_TIMEOUT"===e.reason_code||e.latency_ms&&e.latency_ms>100);return(0,a.jsx)("div",{className:"mt-2 pt-2 border-t border-gray-100",children:(0,a.jsxs)("div",{className:"text-[9px] text-gray-600 leading-relaxed",children:[(0,a.jsx)("span",{className:"font-semibold text-blue-600",children:"[洞察]"})," ",e.region," 地区 eCPM 最高（$",e.avgEcpm.toFixed(2),"），",i?"但目前该地区延迟最高。如果优化该地区 CDN，预计可换回 15% 的折损收入。":"建议重点关注该地区流量质量。"]})})})(),0===t.length&&(0,a.jsx)("div",{className:"text-center py-4 text-gray-500 text-xs",children:"暂无区域数据"})]})}var q=t(8759);function U(){let[e,s]=(0,l.useState)(null),[t,i]=(0,l.useState)(!1),n=async()=>{i(!0);try{let e=await fetch("/api/diagnose"),t=await e.json();s(t)}catch(e){console.error("Error fetching diagnostic:",e)}finally{i(!1)}};(0,l.useEffect)(()=>{n();let e=setInterval(n,3e4);return()=>clearInterval(e)},[]);let r=null==e?void 0:e.structured_report,d=e=>{let s=[],t=e.match(/[\$¥]\d+[.,]?\d*/g);return t&&s.push(...t),s},o=function(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e)return"";let t=e;return d(e).forEach(e=>{t=t.replace(e,'<span class="font-bold text-red-600 bg-red-50 px-1 rounded">'.concat(e,"</span>"))}),s&&(t=(t=(t=(t=t.replace(/【P7 损耗预警】/g,'<span class="font-semibold text-blue-600">[策略预警]</span>')).replace(/【P8 策略建议】/g,'<span class="font-semibold text-blue-600">[策略预警]</span>')).replace(/【P7 级决策建议】/g,"")).replace(/【P8 级决策建议】/g,""),["建议","优化","提升","调整","引导","A/B Test","pCTR","预估点击率","向下偏差","质量分"].forEach(e=>{let s=RegExp(e,"g");t=t.replace(s,'<span class="font-semibold text-blue-600">'.concat(e,"</span>"))})),t};return r||(null==e?void 0:e.total_potential_loss)?(0,a.jsxs)("div",{className:"bg-white rounded-lg border border-gray-100 p-3 shadow-subtle",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-2",children:[(0,a.jsx)(M.Z,{className:"w-3.5 h-3.5 text-blue-600"}),(0,a.jsx)("h3",{className:"text-xs font-bold text-[#1e293b]",children:"智能诊断与决策建议"}),(0,a.jsx)("span",{className:"text-[9px] text-gray-500",children:"AI Insights"}),(null==e?void 0:e.estimated_hourly_loss)&&(0,a.jsxs)("span",{className:"ml-auto text-[10px] text-gray-500",children:["预计损失: ",(0,a.jsxs)("span",{className:"font-bold text-red-600",children:["$",e.estimated_hourly_loss.toFixed(2),"/h"]})]})]}),(0,a.jsxs)("div",{className:"space-y-2.5 text-xs",children:[(null==r?void 0:r.summary)&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3 text-blue-600 flex-shrink-0"}),(0,a.jsx)("span",{className:"text-[10px] font-semibold text-[#1e293b]",children:"现象总结"})]}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed pl-4",dangerouslySetInnerHTML:{__html:o(r.summary)}})]}),(null==r?void 0:r.root_cause)&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)(b.Z,{className:"w-3 h-3 text-amber-600 flex-shrink-0"}),(0,a.jsx)("span",{className:"text-[10px] font-semibold text-[#1e293b]",children:"根因分析"})]}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed pl-4",children:r.root_cause})]}),(null==r?void 0:r.economic_impact)&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3 text-red-600 flex-shrink-0"}),(0,a.jsx)("span",{className:"text-[10px] font-semibold text-[#1e293b]",children:"经济损失评估"})]}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed pl-4",dangerouslySetInnerHTML:{__html:o(r.economic_impact)}})]}),(null==r?void 0:r.action_items)&&r.action_items.length>0&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1.5",children:[(0,a.jsx)(q.Z,{className:"w-3 h-3 text-blue-600 flex-shrink-0"}),(0,a.jsx)("span",{className:"text-[10px] font-semibold text-[#1e293b]",children:"建议操作"})]}),(0,a.jsx)("div",{className:"space-y-1 pl-4",children:r.action_items.slice(0,3).map((e,s)=>(0,a.jsxs)("div",{className:"flex items-start gap-1.5",children:[(0,a.jsxs)("span",{className:"text-blue-600 font-bold text-[10px] mt-0.5",children:[s+1,"."]}),(0,a.jsx)("div",{className:"text-[10px] text-gray-700 leading-relaxed flex-1",dangerouslySetInnerHTML:{__html:o(e,!0)}})]},s))})]})]})]}):(0,a.jsx)("div",{className:"bg-white rounded border border-gray-100 p-3",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(M.Z,{className:"w-4 h-4 text-blue-600 animate-pulse"}),(0,a.jsx)("span",{className:"text-xs font-semibold text-[#1e293b]",children:"AI 专家决策建议"}),t&&(0,a.jsx)("span",{className:"text-[10px] text-gray-500 ml-auto",children:"分析中..."})]})})}var B=t(6235),k=t(8227),Z=t(9223);function H(e){let{logs:s}=e,t=(0,l.useMemo)(()=>{let e=s.filter(e=>"LATENCY_TIMEOUT"===e.reason_code),t=0,a=0;e.forEach(e=>{var s,l,i,n,r,d,c;let o=null!==(c=null!==(d=null!==(r=null!==(n=null===(s=e.internal_variables)||void 0===s?void 0:s.potential_loss)&&void 0!==n?n:null===(l=e.internal_variables)||void 0===l?void 0:l.highest_potential_ecpm_loss)&&void 0!==r?r:null===(i=e.internal_variables)||void 0===i?void 0:i.max_potential_ecpm)&&void 0!==d?d:e.eCPM)&&void 0!==c?c:0;a+=o,t+=o});let l=s.filter(e=>"CREATIVE_MISMATCH"===e.reason_code),i=0;l.forEach(e=>{var s;let t=(null===(s=e.internal_variables)||void 0===s?void 0:s.potential_loss)||e.eCPM||0;i+=t});let n=s.filter(e=>"FLOOR_PRICE_HIGH"===e.reason_code),r=0;n.forEach(e=>{var s;let t=(null===(s=e.internal_variables)||void 0===s?void 0:s.price_gap)||0;r+=t});let d=s.filter(e=>e.saved_amount&&e.saved_amount>0).reduce((e,s)=>e+(s.saved_amount||0),0),c=new Date,o=[];for(let e=5;e>=0;e--){let t=new Date(c.getTime()-12e4*e),a=new Date(t.getTime()-12e4),l=s.filter(e=>{try{let s=new Date(e.timestamp);return s>=a&&s<t}catch(e){return!1}}).filter(e=>"LATENCY_TIMEOUT"===e.reason_code).reduce((e,s)=>{var t,a,l;return e+((null===(t=s.internal_variables)||void 0===t?void 0:t.highest_potential_ecpm_loss)||(null===(a=s.internal_variables)||void 0===a?void 0:a.max_potential_ecpm)||(null===(l=s.internal_variables)||void 0===l?void 0:l.potential_loss)||0)},0);o.push({time:e,value:l})}return{latency:{count:e.length,loss:t,ecpmLoss:a,trend:o},creative:{count:l.length,loss:i,trend:o.map((e,s)=>({time:s,value:.3*e.value}))},floor:{count:n.length,loss:r,trend:o.map((e,s)=>({time:s,value:.2*e.value}))},saved:{amount:d,trend:o.map((e,s)=>({time:s,value:d/6}))}}},[s]);return(0,a.jsxs)("div",{className:"grid grid-cols-12 gap-2 mb-3",children:[(0,a.jsxs)("div",{className:"col-span-3 p-2 bg-white border border-gray-100 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3 text-red-600"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-500",children:[t.latency.count,"次"]})]}),(0,a.jsxs)("div",{className:"flex items-end justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:["$",t.latency.loss.toFixed(2)]}),(0,a.jsx)("div",{className:"text-[9px] text-gray-500",children:"延迟超时损失"})]}),(0,a.jsx)("div",{className:"w-12 h-6",children:(0,a.jsx)(E.h,{width:"100%",height:"100%",children:(0,a.jsx)(k.w,{data:t.latency.trend,children:(0,a.jsx)(Z.x,{type:"monotone",dataKey:"value",stroke:"#dc2626",strokeWidth:1.5,dot:!1,isAnimationActive:!1})})})})]})]}),(0,a.jsxs)("div",{className:"col-span-3 p-2 bg-white border border-gray-100 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3 text-amber-600"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-500",children:[t.creative.count,"次"]})]}),(0,a.jsxs)("div",{className:"flex items-end justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:["$",t.creative.loss.toFixed(2)]}),(0,a.jsx)("div",{className:"text-[9px] text-gray-500",children:"素材不合规损失"})]}),(0,a.jsx)("div",{className:"w-12 h-6",children:(0,a.jsx)(E.h,{width:"100%",height:"100%",children:(0,a.jsx)(k.w,{data:t.creative.trend,children:(0,a.jsx)(Z.x,{type:"monotone",dataKey:"value",stroke:"#d97706",strokeWidth:1.5,dot:!1,isAnimationActive:!1})})})})]})]}),(0,a.jsxs)("div",{className:"col-span-3 p-2 bg-white border border-gray-100 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)(c.Z,{className:"w-3 h-3 text-orange-600"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-500",children:[t.floor.count,"次"]})]}),(0,a.jsxs)("div",{className:"flex items-end justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:["$",t.floor.loss.toFixed(2)]}),(0,a.jsx)("div",{className:"text-[9px] text-gray-500",children:"底价过高损失"})]}),(0,a.jsx)("div",{className:"w-12 h-6",children:(0,a.jsx)(E.h,{width:"100%",height:"100%",children:(0,a.jsx)(k.w,{data:t.floor.trend,children:(0,a.jsx)(Z.x,{type:"monotone",dataKey:"value",stroke:"#ea580c",strokeWidth:1.5,dot:!1,isAnimationActive:!1})})})})]})]}),(0,a.jsxs)("div",{className:"col-span-3 p-2 bg-white border border-gray-100 rounded",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)(B.Z,{className:"w-3 h-3 text-green-600"}),(0,a.jsx)(d.Z,{className:"w-3 h-3 text-green-600"})]}),(0,a.jsxs)("div",{className:"flex items-end justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"text-lg font-bold text-blue-600",children:["$",t.saved.amount.toFixed(2)]}),(0,a.jsx)("div",{className:"text-[9px] text-gray-500",children:"二价机制节省"})]}),(0,a.jsx)("div",{className:"w-12 h-6",children:(0,a.jsx)(E.h,{width:"100%",height:"100%",children:(0,a.jsx)(k.w,{data:t.saved.trend,children:(0,a.jsx)(Z.x,{type:"monotone",dataKey:"value",stroke:"#059669",strokeWidth:1.5,dot:!1,isAnimationActive:!1})})})})]})]})]})}var z=t(8244);function J(e){let{logs:s}=e,[t,i]=(0,l.useState)({summary:"【历史复现】该模式与今天 14:00 的波动高度相似（相似度 85.3%），当时出现 12 次，建议沿用当时的降噪策略。",matches:[{timestamp:new Date(Date.now()-36e5).toISOString(),pattern_type:"14h_brazil_LATENCY_TIMEOUT",frequency:12,avg_loss:.15,similarity_score:.853}]}),[n,r]=(0,l.useState)(!1);return((0,l.useEffect)(()=>{(async()=>{r(!0);try{new Date().getHours();let e={summary:"【历史复现】该模式与今天 14:00 的波动高度相似（相似度 85.3%），当时出现 12 次，建议沿用当时的降噪策略。",matches:[{timestamp:new Date(Date.now()-36e5).toISOString(),pattern_type:"14h_brazil_LATENCY_TIMEOUT",frequency:12,avg_loss:.15,similarity_score:.853}]};e.summary&&e.matches.length>0&&i({summary:e.summary,matches:e.matches})}catch(e){console.error("Error analyzing history:",e)}finally{r(!1)}})()},[s]),t)?(0,a.jsx)("div",{className:"mt-3 p-2.5 bg-blue-50 border border-blue-200 rounded-lg",children:(0,a.jsxs)("div",{className:"flex items-start gap-2",children:[(0,a.jsx)(z.Z,{className:"w-4 h-4 text-blue-600 flex-shrink-0 mt-0.5"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"text-xs font-semibold text-blue-700 mb-1",children:"情景记忆 - 历史模式识别"}),(0,a.jsx)("div",{className:"text-[10px] text-blue-700 leading-relaxed mb-2",children:t.summary}),t.matches.length>0&&(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("div",{className:"text-[9px] font-semibold text-blue-600 mb-1",children:"相关历史记录："}),t.matches.slice(0,3).map((e,s)=>{let t=new Date(e.timestamp),l=t.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),i=t.toLocaleDateString("zh-CN");return(0,a.jsxs)("div",{className:"text-[9px] text-blue-600 p-1 bg-white rounded border border-blue-100",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("span",{children:[i," ",l]}),(0,a.jsxs)("span",{className:"font-semibold",children:[e.frequency,"次"]})]}),(0,a.jsxs)("div",{className:"text-[8px] text-gray-600 mt-0.5",children:["相似度: ",(100*e.similarity_score).toFixed(1),"% | 平均损失: \xa5",e.avg_loss.toFixed(4)]})]},s)})]})]})]})}):null}function K(){let[e,s]=(0,l.useState)([]),[t,n]=(0,l.useState)({request:0,valid:0,bid:0,win:0}),[r,d]=(0,l.useState)(null),[c,o]=(0,l.useState)(!1),[x,m]=(0,l.useState)(new Date),u=async()=>{o(!0);try{let e=[{request_id:"req_001",timestamp:new Date().toISOString(),node:"SSP",action:"REQUEST_GENERATED",decision:"PASS",reason_code:"REQUEST_CREATED",internal_variables:{},reasoning:"SSP 生成广告请求"},{request_id:"req_001",timestamp:new Date().toISOString(),node:"DSP",action:"BID_SUBMITTED",decision:"PASS",reason_code:"BID_SUBMITTED",internal_variables:{final_bid:.5},reasoning:"DSP 提交出价"}];s(e),m(new Date);let t=new Set,a=new Set,l=new Set,i=new Set;e.forEach(e=>{t.add(e.request_id),"SSP"===e.node&&"REQUEST_GENERATED"===e.action&&a.add(e.request_id),"DSP"===e.node&&("BID_CALCULATION"===e.action||"BID_SUBMITTED"===e.action)&&l.add(e.request_id),("AUCTION_RESULT"===e.action||"ADX"===e.node&&"FINAL_DECISION"===e.action&&"PASS"===e.decision)&&i.add(e.request_id)}),n({request:t.size,valid:a.size,bid:l.size,win:i.size})}catch(e){console.error("Failed to fetch logs:",e)}finally{o(!1)}};(0,l.useEffect)(()=>{u();let e=setInterval(u,2e3);return()=>clearInterval(e)},[]);let[h,p]=(0,l.useState)(!1),[b,j]=(0,l.useState)("");(0,l.useEffect)(()=>{p(!0)},[]),(0,l.useEffect)(()=>{h&&x&&j(x.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}))},[h,x]);let N=Array.from(new Set(e.filter(e=>"REJECT"===e.decision&&("FINAL_DECISION"===e.action||"ADX"===e.node)).map(e=>e.request_id)));return(0,a.jsxs)("div",{className:"min-h-screen bg-[#f8f9fa] text-[#1e293b] overflow-hidden relative",children:[(0,a.jsx)("header",{className:"bg-white border-b border-gray-100 px-6 py-3 shadow-subtle",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-xl font-bold text-[#1e293b]",children:"白盒化广告交易看板"}),(0,a.jsx)("p",{className:"text-xs text-gray-500 mt-0.5",children:"Mirix 白盒化广告交易排查看板"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[h&&(0,a.jsxs)("div",{className:"text-sm text-light-text-muted",children:["最后更新: ",b]}),(0,a.jsxs)("button",{onClick:u,disabled:c,className:"flex items-center gap-2 px-4 py-2 bg-light-accent hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm",children:[(0,a.jsx)(i.Z,{className:"w-4 h-4 ".concat(c?"animate-spin":"")}),"刷新"]})]})]})}),(0,a.jsxs)("main",{className:"p-3",children:[(0,a.jsx)(H,{logs:e}),(0,a.jsxs)("div",{className:"grid grid-cols-12 gap-3",children:[(0,a.jsx)("div",{className:"col-span-12 lg:col-span-3 bg-white rounded border border-gray-100 overflow-hidden",children:(0,a.jsx)(v,{logs:e,onRequestClick:e=>d(e)})}),(0,a.jsxs)("div",{className:"col-span-12 lg:col-span-5 space-y-3",children:[(0,a.jsx)(g,{data:t}),(0,a.jsx)(R,{logs:e}),(0,a.jsx)("div",{className:"h-[400px]",children:(0,a.jsx)(y,{logs:e,selectedRequestId:r,onRequestSelect:d})})]}),(0,a.jsxs)("div",{className:"col-span-12 lg:col-span-4 space-y-3",children:[(0,a.jsx)(P,{logs:e}),(0,a.jsx)(O,{}),(0,a.jsx)(U,{})]})]}),(0,a.jsx)(J,{logs:e}),N.length>0&&!r&&(0,a.jsxs)("div",{className:"mt-3 p-2 bg-white rounded border border-gray-100",children:[(0,a.jsx)("h3",{className:"text-[10px] font-semibold text-[#1e293b] mb-1.5",children:"失败请求快速访问"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1",children:N.slice(0,12).map(s=>{let t=e.find(e=>e.request_id===s&&"REJECT"===e.decision),l=(null==t?void 0:t.reason_code)||"REJECTED";return(0,a.jsxs)("button",{onClick:()=>d(s),className:"px-1.5 py-0.5 text-[9px] bg-red-50 hover:bg-red-100 text-red-600 rounded-full border border-red-200 transition-colors font-medium",children:["Req-",s.slice(-4)," \xb7 ",{LATENCY_TIMEOUT:"响应超时",SIZE_MISMATCH:"尺寸不匹配",IN_BLACKLIST:"黑名单过滤",BID_BELOW_FLOOR:"出价低于底价",CREATIVE_MISMATCH:"素材不合规",FLOOR_PRICE_HIGH:"底价过高",REJECTED:"已拒绝"}[l]||l]},s)})})]})]}),(0,a.jsx)("div",{className:"fixed bottom-2 right-2 text-[9px] text-gray-400 pointer-events-none",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{children:"白盒化 ADX - Mirix"}),(0,a.jsx)("div",{className:"text-[8px] mt-0.5",children:"myrawzm0406@163.com"}),(0,a.jsx)("div",{className:"text-[8px]",children:"WeChat: 15301052620"})]})})]})}}},function(e){e.O(0,[486,971,938,744],function(){return e(e.s=6716)}),_N_E=e.O()}]);